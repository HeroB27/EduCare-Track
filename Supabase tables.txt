-- public.profiles
CREATE TABLE public.profiles (
  id uuid,
  role text CHECK (role = ANY (ARRAY['admin','teacher','parent','guard','clinic'])),
  full_name text,
  phone text,
  photo_url text,
  is_active boolean DEFAULT true,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  username text,
  password text,
  email text,
  PRIMARY KEY (id)
);

-- public.teachers
CREATE TABLE public.teachers (
  id uuid,
  employee_no text UNIQUE,
  is_homeroom boolean DEFAULT false,
  is_gatekeeper boolean DEFAULT false,
  assigned_subjects text[],
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (id) REFERENCES public.profiles(id)
);

-- public.parents
CREATE TABLE public.parents (
  id uuid,
  address text,
  occupation text,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (id) REFERENCES public.profiles(id)
);

-- public.guards
CREATE TABLE public.guards (
  id uuid,
  shift text,
  assigned_gate text,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (id) REFERENCES public.profiles(id)
);

-- public.clinic_staff
CREATE TABLE public.clinic_staff (
  id uuid,
  license_no text,
  position text,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (id) REFERENCES public.profiles(id)
);

-- public.admin_staff
CREATE TABLE public.admin_staff (
  id uuid,
  position text,
  permissions jsonb DEFAULT '[]'::jsonb,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (id) REFERENCES public.profiles(id)
);

-- public.students
CREATE TABLE public.students (
  id text,
  lrn text UNIQUE,
  full_name text,
  gender text,
  birth_date date,
  address text,
  class_id text,
  strand text,
  current_status text,
  photo_url text,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  PRIMARY KEY (id)
);

-- public.parent_students
CREATE TABLE public.parent_students (
  parent_id uuid,
  student_id text,
  relationship text,
  PRIMARY KEY (parent_id, student_id),
  FOREIGN KEY (parent_id) REFERENCES public.parents(id),
  FOREIGN KEY (student_id) REFERENCES public.students(id)
);

-- public.classes
CREATE TABLE public.classes (
  id text,
  grade text,
  adviser_id uuid,
  strand text,
  is_active boolean DEFAULT true,
  created_at timestamptz DEFAULT now(),
  level text,
  room text,
  PRIMARY KEY (id),
  FOREIGN KEY (adviser_id) REFERENCES public.teachers(id)
);

-- public.attendance
CREATE TABLE public.attendance (
  id uuid DEFAULT uuid_generate_v4(),
  student_id text,
  class_id text,
  session text CHECK (session = ANY (ARRAY['AM','PM'])),
  status text CHECK (status = ANY (ARRAY['present','late','absent'])),
  method text CHECK (method = ANY (ARRAY['qr','manual'])),
  timestamp timestamptz DEFAULT now(),
  recorded_by uuid,
  remarks text,
  PRIMARY KEY (id),
  FOREIGN KEY (class_id) REFERENCES public.classes(id),
  FOREIGN KEY (recorded_by) REFERENCES public.profiles(id),
  FOREIGN KEY (student_id) REFERENCES public.students(id)
);

-- public.qr_codes
CREATE TABLE public.qr_codes (
  id uuid DEFAULT uuid_generate_v4(),
  student_id text,
  qr_hash text UNIQUE,
  issued_at timestamptz DEFAULT now(),
  expires_at timestamptz,
  is_active boolean DEFAULT true,
  created_by uuid,
  PRIMARY KEY (id),
  FOREIGN KEY (student_id) REFERENCES public.students(id),
  FOREIGN KEY (created_by) REFERENCES public.profiles(id)
);

-- public.clinic_visits
CREATE TABLE public.clinic_visits (
  id uuid DEFAULT uuid_generate_v4(),
  student_id text,
  reason text,
  notes text,
  treated_by uuid,
  outcome text,
  visit_time timestamptz DEFAULT now(),
  medical_findings text,
  treatment_given text,
  recommendations text,
  additional_notes text,
  status text,
  PRIMARY KEY (id),
  FOREIGN KEY (student_id) REFERENCES public.students(id),
  FOREIGN KEY (treated_by) REFERENCES public.clinic_staff(id)
);

-- public.excuse_letters
CREATE TABLE public.excuse_letters (
  id uuid DEFAULT uuid_generate_v4(),
  student_id text,
  parent_id uuid,
  reason text,
  dates jsonb,
  status text CHECK (status = ANY (ARRAY['pending','approved','rejected'])),
  reviewed_by uuid,
  reviewed_at timestamptz,
  created_at timestamptz DEFAULT now(),
  reviewer_notes text,
  PRIMARY KEY (id),
  FOREIGN KEY (student_id) REFERENCES public.students(id),
  FOREIGN KEY (parent_id) REFERENCES public.parents(id),
  FOREIGN KEY (reviewed_by) REFERENCES public.profiles(id)
);

-- public.announcements
CREATE TABLE public.announcements (
  id uuid DEFAULT uuid_generate_v4(),
  title text,
  message text,
  audience text[],
  priority text,
  created_by uuid,
  is_active boolean DEFAULT true,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (created_by) REFERENCES public.profiles(id)
);

-- public.notifications
CREATE TABLE public.notifications (
  id uuid DEFAULT uuid_generate_v4(),
  target_users uuid[],
  title text,
  message text,
  type text,
  read_by uuid[],
  created_at timestamptz DEFAULT now(),
  related_record text,
  is_urgent boolean DEFAULT false,
  student_id text,
  PRIMARY KEY (id)
);

-- public.school_calendar
CREATE TABLE public.school_calendar (
  id uuid DEFAULT uuid_generate_v4(),
  title text,
  type text,
  start_date timestamptz,
  end_date timestamptz,
  notes text,
  created_by uuid,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (created_by) REFERENCES public.profiles(id)
);

-- public.system_settings
CREATE TABLE public.system_settings (
  key text,
  value jsonb,
  updated_at timestamptz DEFAULT now(),
  PRIMARY KEY (key)
);

-- public.class_schedules
CREATE TABLE public.class_schedules (
  id uuid DEFAULT uuid_generate_v4(),
  class_id text,
  subject text,
  teacher_id uuid,
  schedule_text text,
  day_of_week text,
  start_time time,
  end_time time,
  period_number integer,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (class_id) REFERENCES public.classes(id),
  FOREIGN KEY (teacher_id) REFERENCES public.teachers(id)
);

-- public.subject_attendance
CREATE TABLE public.subject_attendance (
  id uuid DEFAULT uuid_generate_v4(),
  schedule_id uuid,
  student_id text,
  status text CHECK (status = ANY (ARRAY['present','late','absent'])),
  date date,
  recorded_by uuid,
  remarks text,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (schedule_id) REFERENCES public.class_schedules(id),
  FOREIGN KEY (student_id) REFERENCES public.students(id),
  FOREIGN KEY (recorded_by) REFERENCES public.profiles(id)
);
