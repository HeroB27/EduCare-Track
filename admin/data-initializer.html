<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EducareTrack Database Initializer</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-success { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        .status-warning { background-color: #fff3cd; color: #856404; }
        .status-info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-bold text-center mb-6">EducareTrack Complete Database Initializer</h1>
        
        <div class="mb-6 p-4 border rounded bg-blue-50">
            <h2 class="font-bold mb-2">Quick Database Setup:</h2>
            <p class="mb-2">This will create all sample data including announcements, excuse letters, and complete attendance records.</p>
            <p class="font-semibold text-red-600">‚ö†Ô∏è Run this once to populate your database completely.</p>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mb-6">
            <button id="initBtn" class="py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
                üöÄ Complete Database Setup
            </button>
            <button id="clearBtn" class="py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition">
                üóëÔ∏è Clear All Data
            </button>
        </div>
        
        <div id="progress" class="mb-6 hidden">
            <h3 class="font-bold mb-2">Setup Progress:</h3>
            <div class="border rounded p-4 bg-gray-50 max-h-96 overflow-y-auto">
                <ul id="progressList"></ul>
            </div>
        </div>
        
        <div id="summary" class="hidden">
            <h3 class="font-bold mb-2">Setup Complete:</h3>
            <div class="border rounded p-4 bg-green-50">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-2">Collection</th>
                            <th class="text-right py-2">Records Created</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTable"></tbody>
                </table>
                <div class="mt-4 p-3 bg-blue-100 rounded">
                    <p class="font-semibold">‚úÖ Database is ready! You can now:</p>
                    <ul class="list-disc list-inside mt-2">
                        <li>Login with any role (admin, teacher, parent, guard, clinic)</li>
                        <li>View sample announcements and notifications</li>
                        <li>Test attendance tracking and clinic visits</li>
                        <li>Review excuse letter workflow</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDdinBZ5X7CbjVHYlE63qWPasSdCOxdBrc",
            authDomain: "final-educare-track.firebaseapp.com",
            projectId: "final-educare-track",
            storageBucket: "final-educare-track.firebasestorage.app",
            messagingSenderId: "845023655182",
            appId: "1:845023655182:web:d3a30337295ba200d1935f"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const db = firebase.firestore();
        
        document.getElementById('initBtn').addEventListener('click', initializeCompleteDatabase);
        document.getElementById('clearBtn').addEventListener('click', clearDatabase);
        
        let progressList = document.getElementById('progressList');
        let summaryTable = document.getElementById('summaryTable');
        let progressDiv = document.getElementById('progress');
        let summaryDiv = document.getElementById('summary');
        
        let summaryData = {};
        
        function logProgress(message, type = 'info') {
            let li = document.createElement('li');
            li.className = `py-1 px-2 rounded mb-1 status-${type}`;
            li.textContent = message;
            progressList.appendChild(li);
            progressList.scrollTop = progressList.scrollHeight;
        }
        
        function updateSummary(collection, count) {
            summaryData[collection] = count;
            summaryTable.innerHTML = '';
            for (let [key, value] of Object.entries(summaryData)) {
                let row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td class="py-2">${key}</td>
                    <td class="py-2 text-right">${value}</td>
                `;
                summaryTable.appendChild(row);
            }
        }

        async function initializeCompleteDatabase() {
            const btn = document.getElementById('initBtn');
            btn.disabled = true;
            btn.textContent = 'Setting up complete database...';
            progressDiv.classList.remove('hidden');
            progressList.innerHTML = '';
            summaryData = {};
            
            try {
                logProgress('üöÄ Starting complete database setup...', 'info');
                
                // 1. Create Users
                logProgress('üë• Creating users...', 'info');
                await createUsers();
                
                // 2. Create Classes
                logProgress('üè´ Creating classes...', 'info');
                await createClasses();
                
                // 3. Create Students
                logProgress('üéì Creating students...', 'info');
                const students = await createStudents();
                
                // 4. Create Sample Records
                logProgress('üìä Creating sample records...', 'info');
                await createSampleRecords(students);
                
                // 5. Create Announcements
                logProgress('üì¢ Creating announcements...', 'info');
                await createAnnouncements();
                
                // 6. Create Excuse Letters
                logProgress('üìù Creating excuse letters...', 'info');
                await createExcuseLetters(students);
                
                logProgress('‚úÖ Complete database setup finished!', 'success');
                summaryDiv.classList.remove('hidden');
                
            } catch (error) {
                logProgress(`‚ùå Error during setup: ${error.message}`, 'error');
                console.error(error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Complete Database Setup';
            }
        }

        async function createUsers() {
            const users = [
                // Admin
                {
                    id: 'admin001',
                    email: 'admin@educaretrack.com',
                    phone: '+639123456789',
                    name: 'School Administrator',
                    role: 'admin',
                    isActive: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                // Guard
                {
                    id: 'guard001',
                    email: 'guard@educaretrack.com',
                    phone: '+639987654321',
                    name: 'Security Guard',
                    role: 'guard',
                    isActive: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                // Clinic Staff
                {
                    id: 'clinic001',
                    email: 'nurse@educaretrack.com',
                    phone: '+639876543210',
                    name: 'Clinic Nurse',
                    role: 'clinic',
                    isActive: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                // Teachers
                {
                    id: 'teacher001',
                    email: 'maria.santos@educaretrack.com',
                    phone: '+639111111111',
                    name: 'Maria Santos',
                    role: 'teacher',
                    classId: 'kinder',
                    isHomeroom: true,
                    isActive: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    id: 'teacher002',
                    email: 'juan.delacruz@educaretrack.com',
                    phone: '+639222222222',
                    name: 'Juan Dela Cruz',
                    role: 'teacher',
                    classId: 'grade7',
                    isHomeroom: true,
                    isActive: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    id: 'teacher003',
                    email: 'ana.reyes@educaretrack.com',
                    phone: '+639333333333',
                    name: 'Ana Reyes',
                    role: 'teacher',
                    classId: 'grade11-stem',
                    isHomeroom: true,
                    isActive: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }
            ];

            // Create parents
            for (let i = 1; i <= 15; i++) {
                users.push({
                    id: `parent${i.toString().padStart(3, '0')}`,
                    email: `parent${i}@educaretrack.com`,
                    phone: `+639${600000000 + i}`,
                    name: `Parent ${i}`,
                    role: 'parent',
                    children: [],
                    isActive: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            let count = 0;
            for (const user of users) {
                await db.collection('users').doc(user.id).set(user);
                count++;
            }
            updateSummary('Users', count);
            logProgress(`‚úÖ Created ${count} users`, 'success');
        }

        async function createClasses() {
            const classes = [
                // Kindergarten
                {
                    id: 'kinder',
                    name: 'Kindergarten',
                    grade: 'Kindergarten',
                    subjects: ['Language', 'Mathematics', 'Science', 'Values Education'],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                // Elementary
                {
                    id: 'grade1',
                    name: 'Grade 1',
                    grade: '1',
                    subjects: ['Math', 'English', 'Filipino', 'Science'],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    id: 'grade2',
                    name: 'Grade 2',
                    grade: '2',
                    subjects: ['Math', 'English', 'Filipino', 'Science'],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                // Junior High
                {
                    id: 'grade7',
                    name: 'Grade 7',
                    grade: '7',
                    subjects: ['English', 'Math', 'Science', 'Filipino'],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                // Senior High
                {
                    id: 'grade11-stem',
                    name: 'Grade 11 STEM',
                    grade: '11',
                    strand: 'STEM',
                    subjects: ['Pre-Calculus', 'General Biology', 'General Chemistry', 'General Physics'],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    id: 'grade11-abm',
                    name: 'Grade 11 ABM',
                    grade: '11',
                    strand: 'ABM',
                    subjects: ['Business Math', 'Fundamentals of ABM', 'Principles of Marketing'],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }
            ];

            let count = 0;
            for (const classData of classes) {
                await db.collection('classes').doc(classData.id).set(classData);
                count++;
            }
            updateSummary('Classes', count);
            logProgress(`‚úÖ Created ${count} classes`, 'success');
        }

        async function createStudents() {
            const classes = ['kinder', 'grade1', 'grade2', 'grade7', 'grade11-stem', 'grade11-abm'];
            const students = [];
            let studentCount = 0;
            let parentIndex = 1;

            for (const classId of classes) {
                for (let i = 1; i <= 5; i++) {
                    const firstName = ['Maria', 'Juan', 'Ana', 'Jose', 'Carmen', 'Antonio', 'Elena'][studentCount % 7];
                    const lastName = ['Santos', 'Reyes', 'Cruz', 'Garcia', 'Lim', 'Tan', 'Sy'][studentCount % 7];
                    const studentId = `EDU-2025-${(1000 + studentCount).toString().slice(-4)}-${(studentCount + 1).toString().padStart(4, '0')}`;
                    const parentId = `parent${parentIndex.toString().padStart(3, '0')}`;

                    const student = {
                        id: studentId,
                        studentId: studentId,
                        name: `${firstName} ${lastName}`,
                        classId: classId,
                        grade: classId.includes('grade') ? classId.replace('grade', '') : 'Kindergarten',
                        strand: classId.includes('stem') ? 'STEM' : classId.includes('abm') ? 'ABM' : '',
                        parentId: parentId,
                        qrCode: `qr_${studentId}`,
                        currentStatus: 'out_school',
                        lastAttendance: null,
                        lastClinicVisit: null,
                        isActive: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await db.collection('students').doc(studentId).set(student);
                    students.push(student);
                    studentCount++;

                    // Update parent's children array
                    const parentRef = db.collection('users').doc(parentId);
                    const parent = await parentRef.get();
                    if (parent.exists) {
                        const currentChildren = parent.data().children || [];
                        await parentRef.update({
                            children: [...currentChildren, studentId]
                        });
                    }

                    // Move to next parent every 2 students
                    if (studentCount % 2 === 0) parentIndex++;
                }
            }

            updateSummary('Students', studentCount);
            logProgress(`‚úÖ Created ${studentCount} students`, 'success');
            return students;
        }

        async function createSampleRecords(students) {
            // Create attendance records for the past 30 days
            let attendanceCount = 0;
            const today = new Date();
            
            logProgress('üìÖ Creating 30 days of attendance records...', 'info');
            
            for (const student of students) {
                // Create attendance records for the past 30 days
                for (let day = 0; day < 30; day++) {
                    const recordDate = new Date(today);
                    recordDate.setDate(today.getDate() - day);
                    
                    // Skip weekends (Saturday = 6, Sunday = 0)
                    if (recordDate.getDay() === 0 || recordDate.getDay() === 6) {
                        continue;
                    }
                    
                    // Randomize attendance patterns (85% present, 10% late, 5% absent)
                    const attendancePattern = Math.random();
                    let status = 'present';
                    let entryHour = 7;
                    let entryMinute = 30;
                    
                    if (attendancePattern < 0.10) {
                        // 10% chance of being late (8:00 AM - 9:30 AM)
                        status = 'late';
                        entryHour = 8 + Math.floor(Math.random() * 2); // 8:00 or 9:00
                        entryMinute = Math.floor(Math.random() * 60); // Random minutes
                    } else if (attendancePattern < 0.15) {
                        // 5% chance of being absent
                        continue; // Skip creating attendance record for absent days
                    }
                    
                    // Create entry record
                    const entryTime = new Date(recordDate);
                    entryTime.setHours(entryHour, entryMinute, 0);
                    
                    const entryRecord = {
                        studentId: student.id,
                        studentName: student.name,
                        classId: student.classId,
                        entryType: 'entry',
                        timestamp: firebase.firestore.Timestamp.fromDate(entryTime),
                        time: `${entryHour.toString().padStart(2, '0')}:${entryMinute.toString().padStart(2, '0')}:00`,
                        session: 'morning',
                        status: status,
                        recordedBy: 'guard001',
                        recordedByName: 'Security Guard',
                        date: firebase.firestore.Timestamp.fromDate(new Date(recordDate.setHours(0, 0, 0, 0)))
                    };
                    await db.collection('attendance').add(entryRecord);
                    attendanceCount++;

                    // Create exit record (4-6 hours after entry)
                    const exitTime = new Date(entryTime);
                    const schoolDuration = 4 + Math.floor(Math.random() * 3); // 4-6 hours
                    exitTime.setHours(entryHour + schoolDuration, Math.floor(Math.random() * 60), 0);
                    
                    const exitRecord = {
                        studentId: student.id,
                        studentName: student.name,
                        classId: student.classId,
                        entryType: 'exit',
                        timestamp: firebase.firestore.Timestamp.fromDate(exitTime),
                        time: `${exitTime.getHours().toString().padStart(2, '0')}:${exitTime.getMinutes().toString().padStart(2, '0')}:00`,
                        session: 'afternoon',
                        status: status,
                        recordedBy: 'guard001',
                        recordedByName: 'Security Guard',
                        date: firebase.firestore.Timestamp.fromDate(new Date(recordDate.setHours(0, 0, 0, 0)))
                    };
                    await db.collection('attendance').add(exitRecord);
                    attendanceCount++;
                }

                // Update student status based on today's attendance
                const todayEntry = Math.random() > 0.1; // 90% chance student entered today
                if (todayEntry) {
                    await db.collection('students').doc(student.id).update({
                        currentStatus: 'in_school',
                        lastAttendance: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            }

            // Create clinic visits for 3 students
            let clinicCount = 0;
            const clinicStudents = students.slice(0, 3);
            
            for (const student of clinicStudents) {
                const visitTime = new Date();
                visitTime.setHours(10, 0, 0);
                
                const clinicVisit = {
                    studentId: student.id,
                    studentName: student.name,
                    classId: student.classId,
                    checkIn: true,
                    timestamp: firebase.firestore.Timestamp.fromDate(visitTime),
                    reason: ['Headache', 'Fever', 'Stomach ache'][clinicCount],
                    notes: 'Student received medication and rest',
                    staffId: 'clinic001',
                    staffName: 'Clinic Nurse'
                };
                await db.collection('clinicVisits').add(clinicVisit);
                clinicCount++;

                // Update student status to in_clinic
                await db.collection('students').doc(student.id).update({
                    currentStatus: 'in_clinic',
                    lastClinicVisit: firebase.firestore.Timestamp.fromDate(visitTime)
                });
            }

            updateSummary('Attendance Records', attendanceCount);
            updateSummary('Clinic Visits', clinicCount);
            logProgress(`‚úÖ Created ${attendanceCount} attendance records (30 days)`, 'success');
            logProgress(`‚úÖ Created ${clinicCount} clinic visits`, 'success');
        }

        async function createAnnouncements() {
            const announcements = [
                {
                    type: 'announcement',
                    title: 'üéâ School Foundation Day Celebration',
                    message: 'Join us for our annual Foundation Day celebration on December 15th! All students are required to wear their traditional Filipino costumes. There will be cultural presentations, games, and food stalls. Classes will end at 12:00 PM.',
                    targetUsers: ['parent001', 'parent002', 'parent003', 'parent004', 'parent005', 'parent006', 'parent007', 'parent008', 'parent009', 'parent010'],
                    isUrgent: false,
                    readBy: [],
                    createdAt: firebase.firestore.Timestamp.fromDate(new Date('2024-11-28'))
                },
                {
                    type: 'announcement',
                    title: 'üìö Parent-Teacher Conference Schedule',
                    message: 'The quarterly Parent-Teacher Conference will be held on December 5-6, 2024. Please check the schedule assigned to your child\'s section. Conference slots are available from 8:00 AM to 4:00 PM. Kindly confirm your attendance with the class adviser.',
                    targetUsers: ['parent001', 'parent002', 'parent003', 'parent004', 'parent005'],
                    isUrgent: false,
                    readBy: [],
                    createdAt: firebase.firestore.Timestamp.fromDate(new Date('2024-11-25'))
                },
                {
                    type: 'announcement',
                    title: '‚ö†Ô∏è Important: Health Advisory',
                    message: 'Due to the increasing cases of flu in our community, we remind everyone to practice proper hygiene. Students with fever, cough, or colds should stay home and rest. Face masks are recommended in crowded areas.',
                    targetUsers: ['parent001', 'parent002', 'parent003', 'parent004', 'parent005', 'parent006', 'parent007', 'parent008', 'parent009', 'parent010', 'parent011', 'parent012', 'parent013', 'parent014', 'parent015'],
                    isUrgent: true,
                    readBy: [],
                    createdAt: firebase.firestore.Timestamp.fromDate(new Date('2024-11-20'))
                }
            ];

            let count = 0;
            for (const announcement of announcements) {
                await db.collection('notifications').add(announcement);
                count++;
            }
            updateSummary('Announcements', count);
            logProgress(`‚úÖ Created ${count} announcements`, 'success');
        }

        async function createExcuseLetters(students) {
            const excuseLetters = [
                {
                    studentId: students[0].id,
                    parentId: students[0].parentId,
                    reason: 'Family emergency - out of town',
                    dates: [
                        firebase.firestore.Timestamp.fromDate(new Date('2024-11-25')),
                        firebase.firestore.Timestamp.fromDate(new Date('2024-11-26'))
                    ],
                    attachment: '',
                    status: 'approved',
                    reviewedBy: 'teacher001',
                    feedback: 'Approved. Please coordinate with classmates for missed lessons.',
                    submittedAt: firebase.firestore.Timestamp.fromDate(new Date('2024-11-24'))
                },
                {
                    studentId: students[1].id,
                    parentId: students[1].parentId,
                    reason: 'Medical appointment for dental checkup',
                    dates: [
                        firebase.firestore.Timestamp.fromDate(new Date('2024-11-27'))
                    ],
                    attachment: '',
                    status: 'approved',
                    reviewedBy: 'teacher002',
                    feedback: 'Approved. Bring medical certificate upon return.',
                    submittedAt: firebase.firestore.Timestamp.fromDate(new Date('2024-11-26'))
                },
                {
                    studentId: students[2].id,
                    parentId: students[2].parentId,
                    reason: 'Participating in regional sports competition',
                    dates: [
                        firebase.firestore.Timestamp.fromDate(new Date('2024-12-01')),
                        firebase.firestore.Timestamp.fromDate(new Date('2024-12-02')),
                        firebase.firestore.Timestamp.fromDate(new Date('2024-12-03'))
                    ],
                    attachment: '',
                    status: 'pending',
                    reviewedBy: '',
                    feedback: '',
                    submittedAt: firebase.firestore.Timestamp.fromDate(new Date('2024-11-28'))
                },
                {
                    studentId: students[3].id,
                    parentId: students[3].parentId,
                    reason: 'Recovering from flu and fever',
                    dates: [
                        firebase.firestore.Timestamp.fromDate(new Date('2024-11-20')),
                        firebase.firestore.Timestamp.fromDate(new Date('2024-11-21'))
                    ],
                    attachment: '',
                    status: 'approved',
                    reviewedBy: 'teacher001',
                    feedback: 'Get well soon! Medical certificate received.',
                    submittedAt: firebase.firestore.Timestamp.fromDate(new Date('2024-11-19'))
                },
                {
                    studentId: students[4].id,
                    parentId: students[4].parentId,
                    reason: 'Family vacation during long weekend',
                    dates: [
                        firebase.firestore.Timestamp.fromDate(new Date('2024-11-29')),
                        firebase.firestore.Timestamp.fromDate(new Date('2024-11-30'))
                    ],
                    attachment: '',
                    status: 'rejected',
                    reviewedBy: 'teacher002',
                    feedback: 'Cannot be approved as these are regular school days. Family vacations should be scheduled during school breaks.',
                    submittedAt: firebase.firestore.Timestamp.fromDate(new Date('2024-11-27'))
                }
            ];

            let count = 0;
            for (const letter of excuseLetters) {
                await db.collection('excuseLetters').add(letter);
                count++;
            }
            updateSummary('Excuse Letters', count);
            logProgress(`‚úÖ Created ${count} excuse letters`, 'success');
        }

        async function clearDatabase() {
            const btn = document.getElementById('clearBtn');
            btn.disabled = true;
            btn.textContent = 'Clearing database...';
            progressDiv.classList.remove('hidden');
            progressList.innerHTML = '';
            
            try {
                logProgress('Starting database cleanup...', 'warning');
                const collections = ['attendance', 'clinicVisits', 'notifications', 'excuseLetters', 'students', 'classes', 'users'];
                let totalDeleted = 0;

                for (const collectionName of collections) {
                    const snapshot = await db.collection(collectionName).get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    logProgress(`Cleared ${snapshot.size} records from ${collectionName}`, 'success');
                    totalDeleted += snapshot.size;
                }

                logProgress(`‚úÖ Database cleanup completed! ${totalDeleted} records deleted.`, 'success');
                summaryDiv.classList.add('hidden');
            } catch (error) {
                logProgress(`‚ùå Error during cleanup: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üóëÔ∏è Clear All Data';
            }
        }
    </script>
</body>
</html>
