<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EducareTrack - Announcements</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .sidebar { transition: all 0.3s ease; }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .sidebar-text { display: none; }
        .main-content { transition: all 0.3s ease; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .urgent-announcement { border-left: 4px solid #ef4444; }
        .normal-announcement { border-left: 4px solid #3b82f6; }
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation Sidebar -->
    <div class="sidebar flex flex-col h-screen bg-white shadow-lg w-64 fixed z-40">
        <!-- Logo -->
        <div class="p-6 border-b border-gray-200 flex items-center">
            <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center mr-3">
                <span class="text-white font-bold">ET</span>
            </div>
            <h1 class="text-xl font-bold text-blue-800 sidebar-text">EducareTrack</h1>
            <button id="sidebarToggle" class="ml-auto md:hidden">
                <i class="fas fa-times text-gray-600"></i>
            </button>
        </div>
        
        <!-- User Info -->
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                    <span class="text-blue-600 font-semibold" id="userInitials">AD</span>
                </div>
                <div class="ml-3 sidebar-text">
                    <h2 class="font-semibold text-gray-800" id="userName">Admin User</h2>
                    <p class="text-sm text-gray-600 capitalize" id="userRole">admin</p>
                </div>
            </div>
        </div>
        
        <!-- Navigation Menu -->
<nav class="flex-1 p-4">
    <ul class="space-y-2">
        <li>
            <a href="admin-dashboard.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-tachometer-alt w-5 h-5 mr-3"></i>
                <span class="sidebar-text">Dashboard</span>
            </a>
        </li>
        <li>
            <a href="user-management.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-users w-5 h-5 mr-3"></i>
                <span class="sidebar-text">User Management</span>
            </a>
        </li>
        <li>
            <a href="student-management.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-user-graduate w-5 h-5 mr-3"></i>
                <span class="sidebar-text">Student Management</span>
            </a>
        </li>
        <li>
            <a href="class-management.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-chalkboard w-5 h-5 mr-3"></i>
                <span class="sidebar-text">Class Management</span>
            </a>
        </li>
        <li>
            <a href="attendance.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-clipboard-check w-5 h-5 mr-3"></i>
                <span class="sidebar-text">Attendance</span>
            </a>
        </li>
        <li>
            <a href="admin-records.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-chart-bar w-5 h-5 mr-3"></i>
                <span class="sidebar-text">Reports & Analytics</span>
            </a>
        </li>
        <li>
            <a href="announcements.html" class="nav-item flex items-center p-3 text-blue-600 bg-blue-50 rounded-lg transition duration-200">
                <i class="fas fa-bullhorn w-5 h-5 mr-3"></i>
                <span class="sidebar-text font-medium">Announcements</span>
            </a>
        </li>
        <li>
            <a href="id-management.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-id-card w-5 h-5 mr-3"></i>
                <span class="sidebar-text">ID Management</span>
            </a>
        </li>
        <li>
            <a href="add-parent-student.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-user-plus w-5 h-5 mr-3"></i>
                <span class="sidebar-text">Enroll Student</span>
            </a>
        </li>
        <li>
            <a href="admin-notifications.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-bell w-5 h-5 mr-3"></i>
                <span class="sidebar-text">Notifications</span>
                <span id="notificationBoxCount" class="ml-auto text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-600 hidden">0</span>
            </a>
        </li>
    </ul>
</nav>
        
        <!-- Footer -->
        <div class="p-4 border-t border-gray-200">
            <button id="logoutBtn" class="w-full flex items-center justify-center p-2 text-gray-600 hover:text-red-600 rounded-lg transition duration-200 sidebar-text">
                <i class="fas fa-sign-out-alt w-5 h-5 mr-2"></i>
                Sign Out
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content ml-64 p-6 fade-in">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Announcements</h1>
                <p class="text-gray-600">Create and manage school announcements</p>
            </div>
            <div class="flex items-center space-x-4">
                <button id="createAnnouncementBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center">
                    <i class="fas fa-plus mr-2"></i>
                    New Announcement
                </button>
            </div>
        </header>

        <!-- Announcements Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Announcements List -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-semibold text-gray-800">Recent Announcements</h2>
                            <div class="flex space-x-2">
                                <button id="filterAll" class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-md filter-btn active">All</button>
                                <button id="filterUrgent" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-md filter-btn">Urgent</button>
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <div id="announcementsList" class="space-y-4">
                            <!-- Announcements will be loaded here -->
                            <div class="flex items-center justify-center py-8">
                                <div class="text-center">
                                    <i class="fas fa-bullhorn text-4xl text-gray-300 mb-3"></i>
                                    <p class="text-gray-500">No announcements yet</p>
                                    <button id="createFirstAnnouncement" class="mt-2 text-blue-600 hover:text-blue-800">
                                        Create your first announcement
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats and Info -->
            <div class="space-y-6">
                <!-- Announcement Stats -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Announcement Stats</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Total Announcements</span>
                            <span class="font-semibold" id="totalAnnouncements">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Active Announcements</span>
                            <span class="font-semibold" id="activeAnnouncements">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Urgent Announcements</span>
                            <span class="font-semibold text-red-600" id="urgentAnnouncements">0</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Tips -->
                <div class="bg-blue-50 rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-blue-800 mb-3">Tips for Effective Announcements</h3>
                    <ul class="text-sm text-blue-700 space-y-2">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle mt-1 mr-2 text-blue-600"></i>
                            <span>Keep messages clear and concise</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle mt-1 mr-2 text-blue-600"></i>
                            <span>Use urgent flag only for critical information</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle mt-1 mr-2 text-blue-600"></i>
                            <span>Select the appropriate audience for each message</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle mt-1 mr-2 text-blue-600"></i>
                            <span>Include dates and deadlines when relevant</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Announcement Modal -->
    <div id="createAnnouncementModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="bg-blue-600 text-white p-4 rounded-t-lg flex justify-between items-center">
                <h3 class="text-lg font-semibold">Create New Announcement</h3>
                <button onclick="closeCreateAnnouncementModal()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-6">
                <form id="announcementForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                        <input type="text" id="announcementTitle" required 
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Enter announcement title">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Message *</label>
                        <textarea id="announcementMessage" required rows="5"
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="Enter announcement message"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Audience *</label>
                            <select id="announcementAudience" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="all">All Users</option>
                                <option value="parents">Parents Only</option>
                                <option value="teachers">Teachers Only</option>
                                <option value="students">Students Only</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Expiration Date</label>
                            <input type="date" id="announcementExpiry"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="announcementUrgent" 
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="announcementUrgent" class="ml-2 block text-sm text-gray-700">
                            Mark as urgent (will send immediate notifications)
                        </label>
                    </div>
                </form>
            </div>
            
            <div class="bg-gray-50 px-6 py-4 rounded-b-lg flex justify-end space-x-3">
                <button onclick="closeCreateAnnouncementModal()" 
                        class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                    Cancel
                </button>
                <button onclick="submitAnnouncement()" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                    <i class="fas fa-bullhorn mr-2"></i>Publish Announcement
                </button>
            </div>
        </div>
    </div>

    <!-- Announcement Detail Modal -->
    <div id="announcementDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="bg-blue-600 text-white p-4 rounded-t-lg flex justify-between items-center">
                <h3 class="text-lg font-semibold">Announcement Details</h3>
                <button onclick="closeAnnouncementDetailModal()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-6">
                <div id="announcementDetailContent">
                    <!-- Announcement details will be loaded here -->
                </div>
            </div>
            
            <div class="bg-gray-50 px-6 py-4 rounded-b-lg flex justify-between">
                <div>
                    <button onclick="deleteAnnouncement()" 
                            class="px-4 py-2 text-red-600 hover:text-red-800 transition-colors">
                        <i class="fas fa-trash mr-2"></i>Delete
                    </button>
                </div>
                <div>
                    <button onclick="closeAnnouncementDetailModal()" 
                            class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600">Loading...</p>
        </div>
    </div>

    <!-- Include Core JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../supabase-config.js"></script>
    <script src="../core.js"></script>
    
    <!-- Announcements Script -->
    <script>
        class AnnouncementsManager {
            constructor() {
                this.currentUser = null;
                this.announcements = [];
                this.filteredAnnouncements = [];
                this.currentFilter = 'all';
                this.selectedAnnouncement = null;
                this.init();
            }

            async init() {
                try {
                    this.showLoading();
                    
                    // Wait for EducareTrack to be ready
                    if (!window.EducareTrack) {
                        setTimeout(() => this.init(), 100);
                        return;
                    }

                    // Check if user is logged in
                    const savedUser = localStorage.getItem('educareTrack_user');
                    if (!savedUser) {
                        window.location.href = '../index.html';
                        return;
                    }

                    this.currentUser = JSON.parse(savedUser);
                    this.updateUI();
                    await this.loadAnnouncements();
                    this.initEventListeners();
                    
                    this.hideLoading();
                } catch (error) {
                    console.error('Announcements manager initialization failed:', error);
                    this.hideLoading();
                }
            }

            updateUI() {
                document.getElementById('userName').textContent = this.currentUser.name;
                document.getElementById('userRole').textContent = this.currentUser.role;
                document.getElementById('userInitials').textContent = this.currentUser.name
                    .split(' ')
                    .map(n => n[0])
                    .join('')
                    .substring(0, 2)
                    .toUpperCase();

                // Hide create button if user doesn't have permission
                if (this.currentUser.role !== 'admin' && this.currentUser.role !== 'teacher') {
                    document.getElementById('createAnnouncementBtn').classList.add('hidden');
                    document.getElementById('createFirstAnnouncement').classList.add('hidden');
                }
            }

            async loadAnnouncements() {
                try {
                    if (!window.EducareTrack) {
                        console.error('EducareTrack not available');
                        return;
                    }

                    this.announcements = await EducareTrack.getAnnouncements(50);
                    this.applyFilter(this.currentFilter);
                    this.updateStats();
                } catch (error) {
                    console.error('Error loading announcements:', error);
                    this.showError('Failed to load announcements');
                }
            }

            applyFilter(filter) {
                this.currentFilter = filter;
                
                if (filter === 'all') {
                    this.filteredAnnouncements = [...this.announcements];
                } else if (filter === 'urgent') {
                    this.filteredAnnouncements = this.announcements.filter(announcement => 
                        announcement.isUrgent === true
                    );
                }
                
                this.renderAnnouncements();
            }

            renderAnnouncements() {
                const container = document.getElementById('announcementsList');
                
                if (this.filteredAnnouncements.length === 0) {
                    container.innerHTML = `
                        <div class="flex items-center justify-center py-8">
                            <div class="text-center">
                                <i class="fas fa-bullhorn text-4xl text-gray-300 mb-3"></i>
                                <p class="text-gray-500">No announcements found</p>
                                ${this.currentUser.role === 'admin' || this.currentUser.role === 'teacher' ? 
                                    `<button onclick="openCreateAnnouncementModal()" class="mt-2 text-blue-600 hover:text-blue-800">
                                        Create your first announcement
                                    </button>` : ''
                                }
                            </div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.filteredAnnouncements.map(announcement => `
                    <div class="announcement-item bg-white rounded-lg shadow-sm border ${announcement.isUrgent ? 'urgent-announcement' : 'normal-announcement'} p-4 card-hover cursor-pointer" 
                         data-id="${announcement.id}">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold text-gray-800">${this.escapeHtml(announcement.title)}</h3>
                            <div class="flex items-center space-x-2">
                                ${announcement.isUrgent ? 
                                    '<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">Urgent</span>' : ''}
                                <span class="text-xs text-gray-500">${this.formatDate(announcement.createdAt)}</span>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm mb-3 line-clamp-2">${this.escapeHtml(announcement.message)}</p>
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <div class="flex items-center">
                                <i class="fas fa-user mr-1"></i>
                                <span>By ${this.escapeHtml(announcement.createdByName || 'Unknown')}</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-users mr-1"></i>
                                <span>${this.getAudienceText(announcement.audience)}</span>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Add click event listeners to announcement items
                document.querySelectorAll('.announcement-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const announcementId = item.getAttribute('data-id');
                        this.showAnnouncementDetail(announcementId);
                    });
                });
            }

            showAnnouncementDetail(announcementId) {
                this.selectedAnnouncement = this.announcements.find(a => a.id === announcementId);
                
                if (!this.selectedAnnouncement) {
                    this.showError('Announcement not found');
                    return;
                }

                const content = document.getElementById('announcementDetailContent');
                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="flex justify-between items-start">
                            <h3 class="text-xl font-bold text-gray-800">${this.escapeHtml(this.selectedAnnouncement.title)}</h3>
                            ${this.selectedAnnouncement.isUrgent ? 
                                '<span class="bg-red-100 text-red-800 text-sm px-3 py-1 rounded-full">Urgent</span>' : ''}
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-gray-700 whitespace-pre-line">${this.escapeHtml(this.selectedAnnouncement.message)}</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                            <div>
                                <p><strong>Audience:</strong> ${this.getAudienceText(this.selectedAnnouncement.audience)}</p>
                                <p><strong>Created by:</strong> ${this.escapeHtml(this.selectedAnnouncement.createdByName || 'Unknown')}</p>
                            </div>
                            <div>
                                <p><strong>Published:</strong> ${this.formatDateTime(this.selectedAnnouncement.createdAt)}</p>
                                ${this.selectedAnnouncement.expiryDate ? 
                                    `<p><strong>Expires:</strong> ${this.formatDate(this.selectedAnnouncement.expiryDate)}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;

                // Show/hide delete button based on permissions
                const deleteBtn = document.querySelector('#announcementDetailModal button[onclick="deleteAnnouncement()"]');
                if (this.currentUser.role !== 'admin' && this.currentUser.role !== 'teacher') {
                    deleteBtn.classList.add('hidden');
                } else {
                    deleteBtn.classList.remove('hidden');
                }

                this.openAnnouncementDetailModal();
            }

            updateStats() {
                const total = this.announcements.length;
                const active = this.announcements.filter(a => a.is_active !== false).length;
                const urgent = this.announcements.filter(a => a.isUrgent === true).length;

                document.getElementById('totalAnnouncements').textContent = total;
                document.getElementById('activeAnnouncements').textContent = active;
                document.getElementById('urgentAnnouncements').textContent = urgent;
            }

            getAudienceText(audience) {
                const audienceMap = {
                    'all': 'All Users',
                    'parents': 'Parents Only',
                    'teachers': 'Teachers Only',
                    'students': 'Students Only'
                };
                return audienceMap[audience] || audience;
            }

            formatDate(date) {
                if (!date) return 'N/A';
                try {
                    return new Date(date.toDate ? date.toDate() : date).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (error) {
                    return 'Invalid Date';
                }
            }

            formatDateTime(date) {
                if (!date) return 'N/A';
                try {
                    return new Date(date.toDate ? date.toDate() : date).toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (error) {
                    return 'Invalid Date';
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            initEventListeners() {
                // Sidebar toggle
                document.getElementById('sidebarToggle').addEventListener('click', () => {
                    this.toggleSidebar();
                });

                // Logout via modal
                document.getElementById('logoutBtn').addEventListener('click', async () => {
                    const ok = window.EducareTrack && typeof window.EducareTrack.confirmAction === 'function'
                        ? await window.EducareTrack.confirmAction('Are you sure you want to logout?', 'Confirm Logout', 'Logout', 'Cancel')
                        : true;
                    if (ok) {
                        localStorage.removeItem('educareTrack_user');
                        window.location.href = '../index.html';
                    }
                });

                // Create announcement button
                document.getElementById('createAnnouncementBtn').addEventListener('click', () => {
                    this.openCreateAnnouncementModal();
                });

                document.getElementById('createFirstAnnouncement').addEventListener('click', () => {
                    this.openCreateAnnouncementModal();
                });

                // Filter buttons
                document.getElementById('filterAll').addEventListener('click', () => {
                    this.setActiveFilter('filterAll');
                    this.applyFilter('all');
                });

                document.getElementById('filterUrgent').addEventListener('click', () => {
                    this.setActiveFilter('filterUrgent');
                    this.applyFilter('urgent');
                });

                // Close modals on outside click
                document.getElementById('createAnnouncementModal').addEventListener('click', (e) => {
                    if (e.target.id === 'createAnnouncementModal') {
                        this.closeCreateAnnouncementModal();
                    }
                });

                document.getElementById('announcementDetailModal').addEventListener('click', (e) => {
                    if (e.target.id === 'announcementDetailModal') {
                        this.closeAnnouncementDetailModal();
                    }
                });

                // Escape key to close modals
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeCreateAnnouncementModal();
                        this.closeAnnouncementDetailModal();
                    }
                });
            }

            setActiveFilter(activeId) {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active', 'bg-blue-100', 'text-blue-700');
                    btn.classList.add('bg-gray-100', 'text-gray-700');
                });
                
                const activeBtn = document.getElementById(activeId);
                activeBtn.classList.remove('bg-gray-100', 'text-gray-700');
                activeBtn.classList.add('active', 'bg-blue-100', 'text-blue-700');
            }

            openCreateAnnouncementModal() {
                document.getElementById('createAnnouncementModal').classList.remove('hidden');
                document.getElementById('announcementForm').reset();
                
                // Set default expiry date to 7 days from now
                const defaultExpiry = new Date();
                defaultExpiry.setDate(defaultExpiry.getDate() + 7);
                document.getElementById('announcementExpiry').value = defaultExpiry.toISOString().split('T')[0];
            }

            closeCreateAnnouncementModal() {
                document.getElementById('createAnnouncementModal').classList.add('hidden');
            }

            openAnnouncementDetailModal() {
                document.getElementById('announcementDetailModal').classList.remove('hidden');
            }

            closeAnnouncementDetailModal() {
                document.getElementById('announcementDetailModal').classList.add('hidden');
                this.selectedAnnouncement = null;
            }

            async submitAnnouncement() {
                try {
                    const title = document.getElementById('announcementTitle').value;
                    const message = document.getElementById('announcementMessage').value;
                    const audience = document.getElementById('announcementAudience').value;
                    const expiryDate = document.getElementById('announcementExpiry').value;
                    const isUrgent = document.getElementById('announcementUrgent').checked;

                    if (!title || !message) {
                        this.showError('Please fill in all required fields');
                        return;
                    }

                    if (!window.EducareTrack) {
                        this.showError('System not ready. Please try again.');
                        return;
                    }

                    // Show loading
                    const submitBtn = document.querySelector('#createAnnouncementModal button[onclick="submitAnnouncement()"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Publishing...';
                    submitBtn.disabled = true;

                    // Prepare announcement data
                    const announcementData = {
                        title: title,
                        message: message,
                        audience: audience,
                        isUrgent: isUrgent,
                        expiryDate: expiryDate ? new Date(expiryDate) : null
                    };

                    // Create announcement using EducareTrack
                    await EducareTrack.createAnnouncement(announcementData);

                    // Success
                    this.showNotification('Announcement published successfully!', 'success');
                    this.closeCreateAnnouncementModal();
                    
                    // Refresh announcements
                    await this.loadAnnouncements();

                } catch (error) {
                    console.error('Announcement creation error:', error);
                    this.showError('Error creating announcement: ' + error.message);
                    
                    // Reset button
                    const submitBtn = document.querySelector('#createAnnouncementModal button[onclick="submitAnnouncement()"]');
                    submitBtn.innerHTML = '<i class="fas fa-bullhorn mr-2"></i>Publish Announcement';
                    submitBtn.disabled = false;
                }
            }

            async deleteAnnouncement() {
                if (!this.selectedAnnouncement) return;

                const ok = window.EducareTrack && typeof window.EducareTrack.confirmAction === 'function'
                    ? await window.EducareTrack.confirmAction('Are you sure you want to delete this announcement? This action cannot be undone.', 'Delete Announcement', 'Delete', 'Cancel')
                    : true;
                if (!ok) return;

                try {
                    if (!window.EducareTrack) {
                        this.showError('System not ready. Please try again.');
                        return;
                    }

                    // Show loading
                    this.showLoading();

                    // Delete announcement (we'll implement this in core.js)
                    await EducareTrack.deleteAnnouncement(this.selectedAnnouncement.id);

                    // Success
                    this.showNotification('Announcement deleted successfully!', 'success');
                    this.closeAnnouncementDetailModal();
                    
                    // Refresh announcements
                    await this.loadAnnouncements();

                } catch (error) {
                    console.error('Announcement deletion error:', error);
                    this.showError('Error deleting announcement: ' + error.message);
                } finally {
                    this.hideLoading();
                }
            }

            toggleSidebar() {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                
                if (sidebar.classList.contains('collapsed')) {
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('ml-16');
                    mainContent.classList.add('ml-64');
                } else {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.remove('ml-64');
                    mainContent.classList.add('ml-16');
                }
            }

            showLoading() {
                document.getElementById('loadingSpinner').classList.remove('hidden');
            }

            hideLoading() {
                document.getElementById('loadingSpinner').classList.add('hidden');
            }

            showNotification(message, type = 'info') {
                if (window.EducareTrack && typeof window.EducareTrack.showNormalNotification === 'function') {
                    window.EducareTrack.showNormalNotification({ title: type === 'error' ? 'Error' : 'Info', message, type });
                }
            }

            showError(message) {
                this.showNotification(message, 'error');
            }
        }

        // Global functions for modal control
        function openCreateAnnouncementModal() {
            if (window.announcementsManager) {
                window.announcementsManager.openCreateAnnouncementModal();
            }
        }

        function closeCreateAnnouncementModal() {
            if (window.announcementsManager) {
                window.announcementsManager.closeCreateAnnouncementModal();
            }
        }

        function closeAnnouncementDetailModal() {
            if (window.announcementsManager) {
                window.announcementsManager.closeAnnouncementDetailModal();
            }
        }

        function submitAnnouncement() {
            if (window.announcementsManager) {
                window.announcementsManager.submitAnnouncement();
            }
        }

        function deleteAnnouncement() {
            if (window.announcementsManager) {
                window.announcementsManager.deleteAnnouncement();
            }
        }

        // Initialize announcements manager when page loads
        document.addEventListener('DOMContentLoaded', function() {
            window.announcementsManager = new AnnouncementsManager();
        });
    </script>
</body>
</html>
