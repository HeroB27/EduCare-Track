<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EducareTrack - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .sidebar { transition: all 0.3s ease; }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .sidebar-text { display: none; }
        .main-content { transition: all 0.3s ease; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .status-present { background-color: #d1fae5; color: #065f46; }
        .status-absent { background-color: #fee2e2; color: #991b1b; }
        .status-late { background-color: #fef3c7; color: #92400e; }
        .status-clinic { background-color: #dbeafe; color: #1e40af; }
        .role-admin { background-color: #e0e7ff; color: #3730a3; }
        .role-teacher { background-color: #f0fdf4; color: #166534; }
        .role-parent { background-color: #fef7cd; color: #854d0e; }
        .role-guard { background-color: #fce7f3; color: #be185d; }
        .role-clinic { background-color: #dcfce7; color: #166534; }
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation Sidebar -->
    <div class="sidebar flex flex-col h-screen bg-white shadow-lg w-64 fixed z-40">
        <!-- Logo -->
        <div class="p-6 border-b border-gray-200 flex items-center">
            <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center mr-3">
                <span class="text-white font-bold">ET</span>
            </div>
            <h1 class="text-xl font-bold text-blue-800 sidebar-text">EducareTrack</h1>
            <button id="sidebarToggle" class="ml-auto md:hidden">
                <i class="fas fa-times text-gray-600"></i>
            </button>
        </div>
        
        <!-- User Info -->
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                    <span class="text-blue-600 font-semibold" id="userInitials">AD</span>
                </div>
                <div class="ml-3 sidebar-text">
                    <h2 class="font-semibold text-gray-800" id="userName">Admin User</h2>
                    <p class="text-sm text-gray-600 capitalize" id="userRole">admin</p>
                </div>
            </div>
        </div>
        
        <!-- Navigation Menu -->
    <nav class="flex-1 p-4">
    <ul class="space-y-2">
        <li>
            <a href="admin-dashboard.html" class="nav-item flex items-center p-3 text-blue-600 bg-blue-50 rounded-lg transition duration-200">
                <i class="fas fa-tachometer-alt w-5 h-5 mr-3"></i>
                <span class="sidebar-text font-medium">Dashboard</span>
            </a>
        </li>
        <li>
            <a href="user-management.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-users w-5 h-5 mr-3"></i>
                <span class="sidebar-text">User Management</span>
            </a>
        </li>
        <li>
            <a href="student-management.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-user-graduate w-5 h-5 mr-3"></i>
                <span class="sidebar-text">Student Management</span>
            </a>
        </li>
        <li>
            <a href="class-management.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-chalkboard w-5 h-5 mr-3"></i>
                <span class="sidebar-text">Class Management</span>
            </a>
        </li>
        <li>
            <a href="attendance.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-clipboard-check w-5 h-5 mr-3"></i>
                <span class="sidebar-text">Schedule Settings</span>
            </a>
        </li>
        <li>
            <a href="admin-records.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-chart-bar w-5 h-5 mr-3"></i>
                <span class="sidebar-text">Reports & Analytics</span>
            </a>
        </li>
        <li>
            <a href="announcements.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-bullhorn w-5 h-5 mr-3"></i>
                <span class="sidebar-text">Announcements</span>
            </a>
        </li>
        <li>
            <a href="id-management.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-id-card w-5 h-5 mr-3"></i>
                <span class="sidebar-text">ID Management</span>
            </a>
        </li>
        <li>
            <a href="add-parent-student.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-user-plus w-5 h-5 mr-3"></i>
                <span class="sidebar-text">Enroll Student</span>
            </a>
        </li>
        <li>
            <a href="school-calendar.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-calendar-alt w-5 h-5 mr-3"></i>
                <span class="sidebar-text">School Calendar</span>
            </a>
        </li>
        <li>
            <a href="settings.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-cog w-5 h-5 mr-3"></i>
                <span class="sidebar-text">Settings</span>
            </a>
        </li>
        <li>
            <a href="admin-notifications.html" class="nav-item flex items-center p-3 text-gray-700 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                <i class="fas fa-bell w-5 h-5 mr-3"></i>
                <span class="sidebar-text">Notifications</span>
                <span id="notificationBoxCount" class="ml-auto text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-600 hidden">0</span>
            </a>
        </li>
    </ul>
</nav>
        
        <!-- Footer -->
        <div class="p-4 border-t border-gray-200">
            <button id="logoutBtn" class="w-full flex items-center justify-center p-2 text-gray-600 hover:text-red-600 rounded-lg transition duration-200 sidebar-text">
                <i class="fas fa-sign-out-alt w-5 h-5 mr-2"></i>
                Sign Out
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content ml-64 p-6 fade-in">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
                <p class="text-gray-600">Welcome to your dashboard</p>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Current Time -->
                <div class="flex items-center space-x-3">
                    <div class="text-sm text-gray-500">
                        <span id="currentTime">Loading...</span>
                    </div>
                    <button id="logoutBtnHeader" class="px-3 py-2 text-gray-600 hover:text-red-600 bg-white rounded-lg shadow-sm flex items-center">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        <span class="hidden md:inline">Sign Out</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Dashboard Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                        <i class="fas fa-user-graduate text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800" id="totalStudents">0</h3>
                        <p class="text-gray-600">Total Students</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600 mr-4">
                        <i class="fas fa-chalkboard-teacher text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800" id="totalTeachers">0</h3>
                        <p class="text-gray-600">Teachers</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600 mr-4">
                        <i class="fas fa-users text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800" id="totalParents">0</h3>
                        <p class="text-gray-600">Parents</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600 mr-4">
                        <i class="fas fa-chart-line text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800" id="attendanceRate">0%</h3>
                        <p class="text-gray-600">Attendance Rate</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule and Calendar Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Today's Schedule -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Today's Schedule</h3>
                    <a href="attendance.html" class="text-sm text-blue-600 hover:text-blue-800">Manage</a>
                </div>
                <div id="scheduleWidget" class="space-y-4">
                    <div class="flex items-center justify-center h-32">
                        <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    </div>
                </div>
            </div>

            <!-- Calendar Widget -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">School Calendar</h3>
                    <a href="school-calendar.html" class="text-sm text-blue-600 hover:text-blue-800">Full View</a>
                </div>
                <div id="calendarWidget" class="h-64 overflow-y-auto">
                    <!-- Calendar content will be loaded here -->
                    <div class="flex items-center justify-center h-full">
                        <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Quick Actions -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Attendance Chart -->
            <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Attendance Overview</h3>
                    <div class="flex space-x-2">
                        <button id="refreshChart" class="text-gray-500 hover:text-blue-600 transition duration-200" title="Refresh Data">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <select id="chartTimeRange" class="text-sm border border-gray-300 rounded-md px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <option value="7">Last 7 Days</option>
                            <option value="14">Last 14 Days</option>
                            <option value="30">Last 30 Days</option>
                        </select>
                    </div>
                </div>
                <div class="h-64">
                    <canvas id="attendanceChart"></canvas>
                </div>
                <div class="mt-4 text-xs text-gray-500 text-center" id="chartInfo">
                    Loading attendance data...
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Actions</h3>
                <div class="space-y-3">
                    <a href="user-management.html" class="flex items-center p-3 bg-blue-50 hover:bg-blue-100 rounded-lg transition duration-200">
                        <i class="fas fa-users text-blue-600 text-lg mr-3"></i>
                        <span class="font-medium text-blue-800">Manage Users</span>
                    </a>
                    <a href="student-management.html" class="flex items-center p-3 bg-green-50 hover:bg-green-100 rounded-lg transition duration-200">
                        <i class="fas fa-user-graduate text-green-600 text-lg mr-3"></i>
                        <span class="font-medium text-green-800">Manage Students</span>
                    </a>
                    <a href="id-management.html" class="flex items-center p-3 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition duration-200">
                        <i class="fas fa-id-card text-indigo-600 text-lg mr-3"></i>
                        <span class="font-medium text-indigo-800">Manage IDs</span>
                    </a>
                    <a href="add-parent-student.html" class="flex items-center p-3 bg-purple-50 hover:bg-purple-100 rounded-lg transition duration-200">
                        <i class="fas fa-user-plus text-purple-600 text-lg mr-3"></i>
                        <span class="font-medium text-purple-800">Enroll Student</span>
                    </a>
                    <a href="admin-records.html" class="flex items-center p-3 bg-yellow-50 hover:bg-yellow-100 rounded-lg transition duration-200">
                        <i class="fas fa-chart-bar text-yellow-600 text-lg mr-3"></i>
                        <span class="font-medium text-yellow-800">View Reports</span>
                    </a>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Clinic Reasons Trend</h3>
                    <select id="clinicTrendRange" class="text-sm border border-gray-300 rounded-md px-2 py-1">
                        <option value="7">7d</option>
                        <option value="30">30d</option>
                        <option value="90">90d</option>
                    </select>
                </div>
                <div class="h-64">
                    <canvas id="clinicReasonsChart"></canvas>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6 lg:col-span-2">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Absence Reasons & Status</h3>
                    <select id="absenceTrendRange" class="text-sm border border-gray-300 rounded-md px-2 py-1">
                        <option value="30">30d</option>
                        <option value="90">90d</option>
                        <option value="180">180d</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch">
                    <div class="h-64">
                        <canvas id="absenceReasonsChart"></canvas>
                    </div>
                    <div class="h-64">
                        <canvas id="excusedDonut"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity and System Status -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Recent Activity -->
            <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Recent Activity</h3>
                <div id="recentActivity" class="space-y-3">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-user-clock text-blue-600 text-sm"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium">Loading recent activity...</p>
                                <p class="text-xs text-gray-500">Please wait</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- System Status -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">System Status</h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-600 text-lg mr-3"></i>
                            <span class="font-medium text-green-800">Core System</span>
                        </div>
                        <span class="text-green-600 text-sm">Operational</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-database text-green-600 text-lg mr-3"></i>
                            <span class="font-medium text-green-800">Database</span>
                        </div>
                        <span class="text-green-600 text-sm">Connected</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-server text-green-600 text-lg mr-3"></i>
                            <span class="font-medium text-green-800">Services</span>
                        </div>
                        <span class="text-green-600 text-sm">All Running</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-users text-blue-600 text-lg mr-3"></i>
                            <span class="font-medium text-blue-800">Active Users</span>
                        </div>
                        <span class="text-blue-600 text-sm" id="activeUsers">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- At-Risk Students -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">At-Risk Students (Last 14 Days)</h3>
                <button id="refreshAtRisk" class="text-sm text-gray-600 hover:text-blue-600">Refresh</button>
            </div>
            <div id="atRiskList" class="space-y-2">
                <div class="text-gray-500 text-sm">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600">Loading...</p>
        </div>
    </div>

    <!-- Drill-down Modal -->
    <div id="drilldownModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white w-full max-w-3xl rounded-lg shadow-lg">
            <div class="flex items-center justify-between p-4 border-b border-gray-200">
                <div>
                    <h3 id="drilldownTitle" class="text-lg font-semibold text-gray-800">Details</h3>
                    <p id="drilldownSubtitle" class="text-xs text-gray-500"></p>
                </div>
                <button id="closeDrilldown" class="px-3 py-1 text-sm rounded bg-gray-100 text-gray-700">Close</button>
            </div>
            <div class="p-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="text-sm text-gray-600" id="drilldownMeta"></div>
                    <div class="flex items-center space-x-2">
                        <label for="pivotSelect" class="text-sm text-gray-600">Pivot</label>
                        <select id="pivotSelect" class="text-sm border border-gray-300 rounded-md px-2 py-1">
                            <option value="none">None</option>
                            <option value="class_id">By Class</option>
                            <option value="grade">By Grade</option>
                        </select>
                    </div>
                </div>
                <div id="drilldownContent" class="space-y-2 max-h-96 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <!-- Include Core JS -->
    <!-- Database: Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../supabase-config.js"></script>
    <script src="../core.js"></script>
    
    <!-- Dashboard Script -->
    <script>
        class AdminDashboard {
            constructor() {
                this.currentUser = null;
                this.attendanceChart = null;
                this.init();
            }

            async init() {
                try {
                    this.showLoading();
                    
                    // Wait for EducareTrack to be ready
                    if (!window.EducareTrack) {
                        setTimeout(() => this.init(), 100);
                        return;
                    }

                    // Check if user is logged in
                    const savedUser = localStorage.getItem('educareTrack_user');
                    if (!savedUser) {
                        window.location.href = '../index.html';
                        return;
                    }
                    this.currentUser = JSON.parse(savedUser);
                    if (this.currentUser.role !== 'admin') {
                        window.location.href = `../${this.currentUser.role}/${this.currentUser.role}-dashboard.html`;
                        return;
                    }

                    this.updateUI();
                    await this.loadDashboardData();
                    this.initEventListeners();
                    
                    this.hideLoading();
                } catch (error) {
                    console.error('Dashboard initialization failed:', error);
                    this.hideLoading();
                }
            }

            updateUI() {
                // Safely update user info elements
                const userNameEl = document.getElementById('userName');
                const userRoleEl = document.getElementById('userRole');
                const userInitialsEl = document.getElementById('userInitials');
                const currentTimeEl = document.getElementById('currentTime');

                if (userNameEl) userNameEl.textContent = this.currentUser.name;
                if (userRoleEl) userRoleEl.textContent = this.currentUser.role;
                if (userInitialsEl) {
                    userInitialsEl.textContent = this.currentUser.name
                        .split(' ')
                        .map(n => n[0])
                        .join('')
                        .substring(0, 2)
                        .toUpperCase();
                }

                this.updateCurrentTime();
                setInterval(() => this.updateCurrentTime(), 60000);
            }

            updateCurrentTime() {
                const now = new Date();
                const currentTimeEl = document.getElementById('currentTime');
                if (currentTimeEl) {
                    currentTimeEl.textContent = now.toLocaleString('en-US', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            }

            async loadDashboardData() {
                try {
                    if (!window.EducareTrack) {
                        console.error('EducareTrack not available');
                        return;
                    }

                    // Load system stats
                    const stats = await EducareTrack.getSystemStats();
                    this.updateStats(stats);

                    // Setup real-time updates for attendance rate
                    this.setupRealtimeUpdates();

                    // Load schedule and calendar widgets
                    await this.loadScheduleInfo();
                    await this.loadCalendarWidget();

                    // Load recent activity
                    await this.loadRecentActivity();

                    // Update active users count
                    await this.updateActiveUsers();

                    // Load real attendance data for chart
                    await this.loadRealAttendanceData();
                    await this.loadClinicAndAbsenceTrends();

                    // Load at-risk students list
                    await this.loadAtRiskStudents();

                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                }
            }

            setupRealtimeUpdates() {
                if (window.USE_SUPABASE && window.supabaseClient) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    // Listen for new attendance entries
                    window.supabaseClient
                        .channel('dashboard_attendance')
                        .on('postgres_changes', { 
                            event: 'INSERT', 
                            schema: 'public', 
                            table: 'attendance',
                            filter: `timestamp=gte.${today.toISOString()}`
                        }, async (payload) => {
                            // Update stats when new attendance comes in
                            const stats = await EducareTrack.getSystemStats();
                            this.updateStats(stats);
                            // Also refresh the recent activity
                            this.loadRecentActivity();
                        })
                        .subscribe();
                }
            }

            async loadScheduleInfo() {
                const widget = document.getElementById('scheduleWidget');
                if (!widget) return;

                try {
                    // Load schedule settings
                    let settings = null;
                    if (window.USE_SUPABASE && window.supabaseClient) {
                        const { data } = await window.supabaseClient
                            .from('system_settings')
                            .select('value')
                            .eq('key', 'attendance_schedule')
                            .single();
                        if (data) settings = data.value;
                    }

                    // Default settings if none found
                    if (!settings) {
                        settings = {
                            kinder_in: '07:30', kinder_out: '11:30',
                            g1_3_in: '07:30', g1_3_out: '13:00',
                            g4_6_in: '07:30', g4_6_out: '15:00',
                            jhs_in: '07:30', jhs_out: '16:00',
                            shs_in: '07:30', shs_out: '16:30'
                        };
                    }

                    // Determine current status and range
                    const now = new Date();
                    const currentTime = now.getHours() * 60 + now.getMinutes();
                    
                    const timeToMinutes = (timeStr) => {
                        if (!timeStr) return 0;
                        const [h, m] = timeStr.split(':').map(Number);
                        return h * 60 + m;
                    };

                    let earliestStart = 24 * 60;
                    let latestEnd = 0;
                    let activeGrades = [];

                    const grades = [
                        { id: 'kinder', name: 'Kindergarten' },
                        { id: 'g1_3', name: 'Grades 1-3' },
                        { id: 'g4_6', name: 'Grades 4-6' },
                        { id: 'jhs', name: 'Junior HS' },
                        { id: 'shs', name: 'Senior HS' }
                    ];

                    grades.forEach(grade => {
                        const startStr = settings[`${grade.id}_in`];
                        const endStr = settings[`${grade.id}_out`];
                        
                        if (startStr && endStr) {
                            const start = timeToMinutes(startStr);
                            const end = timeToMinutes(endStr);
                            
                            if (start < earliestStart) earliestStart = start;
                            if (end > latestEnd) latestEnd = end;

                            if (currentTime >= start && currentTime < end) {
                                activeGrades.push(grade.name);
                            }
                        }
                    });

                    const formatTime = (minutes) => {
                        const h = Math.floor(minutes / 60);
                        const m = minutes % 60;
                        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    };

                    let statusHtml = '';
                    let statusColor = 'text-gray-600';
                    let statusIcon = 'fa-clock';

                    if (activeGrades.length > 0) {
                        statusHtml = 'Classes in Session';
                        statusColor = 'text-green-600';
                        statusIcon = 'fa-school';
                    } else if (currentTime < earliestStart) {
                        statusHtml = 'Before School';
                        statusColor = 'text-indigo-600';
                        statusIcon = 'fa-coffee';
                    } else if (currentTime >= latestEnd) {
                        statusHtml = 'Classes Ended';
                        statusColor = 'text-blue-600';
                        statusIcon = 'fa-moon';
                    } else {
                        // In between (e.g. if there's a gap, though unlikely with current logic)
                        statusHtml = 'No Active Classes';
                        statusColor = 'text-gray-600';
                        statusIcon = 'fa-pause';
                    }

                    // Build Schedule List
                    const scheduleList = grades.map(grade => {
                        const start = settings[`${grade.id}_in`] || '--:--';
                        const end = settings[`${grade.id}_out`] || '--:--';
                        return `
                            <div class="flex justify-between text-xs py-1 border-b border-gray-100 last:border-0">
                                <span class="text-gray-600">${grade.name}</span>
                                <span class="font-medium text-gray-800">${start} - ${end}</span>
                            </div>
                        `;
                    }).join('');

                    widget.innerHTML = `
                        <div class="flex items-center p-4 bg-gray-50 rounded-lg mb-4">
                            <div class="p-3 rounded-full bg-white shadow-sm mr-4 ${statusColor}">
                                <i class="fas ${statusIcon} text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">${statusHtml}</h4>
                                <p class="text-sm text-gray-500">${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded border border-gray-100 p-3">
                            <h5 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Grade Schedules</h5>
                            <div class="space-y-1">
                                ${scheduleList}
                            </div>
                        </div>
                        
                        <div class="mt-3 text-xs text-center text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>
                            School Hours: ${formatTime(earliestStart)} - ${formatTime(latestEnd)}
                        </div>
                    `;

                } catch (error) {
                    console.error('Error loading schedule info:', error);
                    widget.innerHTML = '<p class="text-red-500 text-sm">Error loading schedule</p>';
                }
            }

            async loadCalendarWidget() {
                const widget = document.getElementById('calendarWidget');
                if (!widget) return;

                // Load calendar settings
                let settings = { enableSaturdayClasses: false, enableSundayClasses: false };
                if (window.USE_SUPABASE && window.supabaseClient) {
                    const { data } = await window.supabaseClient
                        .from('system_settings')
                        .select('value')
                        .eq('key', 'calendar_settings')
                        .single();
                    if (data) settings = data.value;
                }

                // Simple calendar render
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                
                const firstDay = new Date(currentYear, currentMonth, 1);
                const lastDay = new Date(currentYear, currentMonth + 1, 0);
                
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                
                let html = `
                    <div class="text-center font-semibold mb-2 text-gray-700">
                        ${monthNames[currentMonth]} ${currentYear}
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center text-xs mb-1">
                        <div class="text-gray-400">Su</div>
                        <div class="text-gray-400">Mo</div>
                        <div class="text-gray-400">Tu</div>
                        <div class="text-gray-400">We</div>
                        <div class="text-gray-400">Th</div>
                        <div class="text-gray-400">Fr</div>
                        <div class="text-gray-400">Sa</div>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center text-sm">
                `;

                // Empty cells for days before first day of month
                for (let i = 0; i < firstDay.getDay(); i++) {
                    html += `<div></div>`;
                }

                // Days
                for (let i = 1; i <= lastDay.getDate(); i++) {
                    const date = new Date(currentYear, currentMonth, i);
                    const dayOfWeek = date.getDay();
                    const isToday = i === today.getDate();
                    
                    // Check if day is disabled (weekend and not enabled)
                    let isWeekendDisabled = false;
                    if (dayOfWeek === 6 && !settings.enableSaturdayClasses) isWeekendDisabled = true;
                    if (dayOfWeek === 0 && !settings.enableSundayClasses) isWeekendDisabled = true;

                    let classes = '';
                    if (isToday) {
                        classes = 'bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center mx-auto';
                    } else if (isWeekendDisabled) {
                        classes = 'w-8 h-8 flex items-center justify-center mx-auto text-gray-300 bg-gray-50 rounded-full cursor-not-allowed';
                    } else {
                        classes = 'w-8 h-8 flex items-center justify-center mx-auto text-gray-700 hover:bg-gray-100 rounded-full cursor-pointer';
                    }
                    
                    html += `<div class="${classes}">${i}</div>`;
                }

                html += `</div>`;
                
                // Add upcoming events section
                html += `
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <h5 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Upcoming Events</h5>
                        <div id="upcomingEventsList" class="space-y-2">
                            <p class="text-xs text-gray-400 italic">Loading events...</p>
                        </div>
                    </div>
                `;

                widget.innerHTML = html;

                // Load events asynchronously
                this.loadUpcomingEvents();
            }

            async loadUpcomingEvents() {
                const list = document.getElementById('upcomingEventsList');
                if (!list) return;

                try {
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    
                    let events = [];
                    if (window.USE_SUPABASE && window.supabaseClient) {
                        const { data } = await window.supabaseClient
                            .from('calendar_events')
                            .select('*')
                            .gte('start_date', today.toISOString())
                            .order('start_date', { ascending: true })
                            .limit(3);
                        if (data) events = data;
                    }

                    if (events.length === 0) {
                        list.innerHTML = '<p class="text-xs text-gray-400">No upcoming events</p>';
                        return;
                    }

                    list.innerHTML = events.map(event => `
                        <div class="flex items-start space-x-2">
                            <div class="w-1.5 h-1.5 rounded-full bg-blue-500 mt-1.5"></div>
                            <div>
                                <p class="text-sm font-medium text-gray-800">${event.title}</p>
                                <p class="text-xs text-gray-500">${new Date(event.start_date).toLocaleDateString()}</p>
                            </div>
                        </div>
                    `).join('');

                } catch (error) {
                    console.error('Error loading events:', error);
                    list.innerHTML = '<p class="text-xs text-red-400">Error loading events</p>';
                }
            }

            updateStats(stats) {
                const totalStudentsEl = document.getElementById('totalStudents');
                const totalTeachersEl = document.getElementById('totalTeachers');
                const totalParentsEl = document.getElementById('totalParents');
                const attendanceRateEl = document.getElementById('attendanceRate');

                if (totalStudentsEl) totalStudentsEl.textContent = stats.totalStudents || 0;
                if (totalTeachersEl) totalTeachersEl.textContent = stats.totalTeachers || 0;
                if (totalParentsEl) totalParentsEl.textContent = stats.totalParents || 0;
                if (attendanceRateEl) attendanceRateEl.textContent = (stats.attendanceRate || 0) + '%';
            }

            async loadRecentActivity() {
                try {
                    const container = document.getElementById('recentActivity');
                    if (!container) {
                        console.error('Recent activity container not found');
                        return;
                    }

                    const activity = await EducareTrack.getRecentActivity(5);
                    
                    if (activity.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-4 text-gray-500">
                                <i class="fas fa-inbox text-2xl mb-2"></i>
                                <p>No recent activity</p>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = activity.map(item => {
                        let time = 'N/A';
                        if (item.timestamp) {
                            if (typeof item.timestamp.toDate === 'function') {
                                time = this.formatTime(item.timestamp.toDate());
                            } else if (item.timestamp instanceof Date) {
                                time = this.formatTime(item.timestamp);
                            } else if (typeof item.timestamp === 'string') {
                                time = this.formatTime(new Date(item.timestamp));
                            } else {
                                time = this.formatTime(new Date());
                            }
                        }
                        const activityTime = item.time || 'Unknown time';
                        
                        return `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 ${this.getActivityColor(item.entry_type)} rounded-full flex items-center justify-center mr-3">
                                        <i class="${this.getActivityIcon(item.entry_type)} text-sm"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium">${item.studentName || 'Unknown Student'}</p>
                                        <p class="text-xs text-gray-500">${item.entry_type === 'entry' ? 'Entered' : 'Exited'} at ${activityTime}</p>
                                    </div>
                                </div>
                                <span class="text-xs text-gray-500">${activityTime}</span>
                            </div>
                        `;
                    }).join('');
                } catch (error) {
                    console.error('Error loading recent activity:', error);
                    const container = document.getElementById('recentActivity');
                    if (container) {
                        container.innerHTML = `
                            <div class="text-center py-4 text-gray-500">
                                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                                <p>Error loading activity</p>
                            </div>
                        `;
                    }
                }
            }

            async updateActiveUsers() {
                try {
                    const users = await EducareTrack.getUsers();
                    const activeUsers = users.filter(user => user.is_active !== false).length;
                    const activeUsersEl = document.getElementById('activeUsers');
                    if (activeUsersEl) {
                        activeUsersEl.textContent = activeUsers;
                    }
                } catch (error) {
                    console.error('Error loading active users:', error);
                }
            }

            async loadRealAttendanceData() {
                try {
                    this.showLoading();
                    
                    // Get date range for the past 7 days
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - 7);

                    // Get real attendance data
                    const attendanceData = await EducareTrack.getAttendanceTrend(startDate, endDate, 'day');
                    
                    const chartInfoEl = document.getElementById('chartInfo');
                    
                    if (attendanceData && attendanceData.labels && attendanceData.datasets) {
                        this.createRealAttendanceChart(attendanceData);
                        if (chartInfoEl) chartInfoEl.textContent = 'Showing real attendance data from your system';
                    } else {
                        // Fallback to sample data if no real data available
                        this.createSampleAttendanceChart();
                        if (chartInfoEl) chartInfoEl.textContent = 'Showing sample data (no real data available)';
                    }
                    
                    this.hideLoading();
                } catch (error) {
                    console.error('Error loading attendance data:', error);
                    this.createSampleAttendanceChart();
                    const chartInfoEl = document.getElementById('chartInfo');
                    if (chartInfoEl) chartInfoEl.textContent = 'Showing sample data (error loading real data)';
                    this.hideLoading();
                }
            }

            createRealAttendanceChart(attendanceData) {
                const ctx = document.getElementById('attendanceChart');
                if (!ctx) {
                    console.error('Attendance chart canvas not found');
                    return;
                }
                
                const chartCtx = ctx.getContext('2d');
                
                // Destroy existing chart if it exists
                if (this.attendanceChart) {
                    this.attendanceChart.destroy();
                }

                this.attendanceChart = new Chart(chartCtx, {
                    type: 'bar',
                    data: {
                        labels: attendanceData.labels,
                        datasets: [
                            {
                                label: 'Present',
                                data: attendanceData.datasets.present,
                                backgroundColor: '#10B981',
                                borderColor: '#047857',
                                borderWidth: 1
                            },
                            {
                                label: 'Absent',
                                data: attendanceData.datasets.absent,
                                backgroundColor: '#EF4444',
                                borderColor: '#DC2626',
                                borderWidth: 1
                            },
                            {
                                label: 'Late',
                                data: attendanceData.datasets.late,
                                backgroundColor: '#F59E0B',
                                borderColor: '#D97706',
                                borderWidth: 1
                            },
                            {
                                label: 'Clinic',
                                data: attendanceData.datasets.clinic,
                                backgroundColor: '#3B82F6',
                                borderColor: '#1D4ED8',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Students'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value;
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Weekly Attendance Overview'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y;
                                        return `${label}: ${value} students`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            createSampleAttendanceChart() {
                const ctx = document.getElementById('attendanceChart');
                if (!ctx) {
                    console.error('Attendance chart canvas not found');
                    return;
                }
                
                const chartCtx = ctx.getContext('2d');
                
                // Get current date and generate labels for the past 7 days
                const labels = [];
                const presentData = [];
                const absentData = [];
                const lateData = [];
                const clinicData = [];
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric' 
                    }));
                    
                    // Generate realistic sample data
                    const basePresent = Math.floor(Math.random() * 50) + 150;
                    const baseLate = Math.floor(Math.random() * 10) + 5;
                    const baseClinic = Math.floor(Math.random() * 8) + 2;
                    const baseAbsent = Math.floor(Math.random() * 15) + 10;
                    
                    presentData.push(basePresent);
                    lateData.push(baseLate);
                    clinicData.push(baseClinic);
                    absentData.push(baseAbsent);
                }

                if (this.attendanceChart) {
                    this.attendanceChart.destroy();
                }

                this.attendanceChart = new Chart(chartCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Present',
                                data: presentData,
                                backgroundColor: '#10B981',
                                borderColor: '#047857',
                                borderWidth: 1
                            },
                            {
                                label: 'Absent',
                                data: absentData,
                                backgroundColor: '#EF4444',
                                borderColor: '#DC2626',
                                borderWidth: 1
                            },
                            {
                                label: 'Late',
                                data: lateData,
                                backgroundColor: '#F59E0B',
                                borderColor: '#D97706',
                                borderWidth: 1
                            },
                            {
                                label: 'Clinic',
                                data: clinicData,
                                backgroundColor: '#3B82F6',
                                borderColor: '#1D4ED8',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Students'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Weekly Attendance Overview (Sample Data)'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y;
                                        return `${label}: ${value} students`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            async loadAttendanceDataForPeriod(days) {
                try {
                    this.showLoading();
                    
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - days);

                    const attendanceData = await EducareTrack.getAttendanceTrend(startDate, endDate, 'day');
                    
                    const chartInfoEl = document.getElementById('chartInfo');
                    
                    if (attendanceData && attendanceData.labels && attendanceData.datasets) {
                        this.createRealAttendanceChart(attendanceData);
                        if (chartInfoEl) chartInfoEl.textContent = `Showing attendance data for the past ${days} days`;
                    } else {
                        this.createSampleAttendanceChart();
                        if (chartInfoEl) chartInfoEl.textContent = 'Showing sample data (no real data available)';
                    }
                    
                    this.hideLoading();
                } catch (error) {
                    console.error('Error loading attendance data for period:', error);
                    this.createSampleAttendanceChart();
                    const chartInfoEl = document.getElementById('chartInfo');
                    if (chartInfoEl) chartInfoEl.textContent = 'Showing sample data (error loading real data)';
                    this.hideLoading();
                }
            }

            getActivityColor(entry_type) {
                return entry_type === 'entry' ? 'bg-green-100 text-green-600' : 'bg-blue-100 text-blue-600';
            }

            getActivityIcon(entry_type) {
                return entry_type === 'entry' ? 'fas fa-sign-in-alt' : 'fas fa-sign-out-alt';
            }

            formatTime(date) {
                if (!date) return 'N/A';
                try {
                    return new Date(date).toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (error) {
                    return 'Invalid Time';
                }
            }

            initEventListeners() {
                // Sidebar toggle
                const sidebarToggle = document.getElementById('sidebarToggle');
                if (sidebarToggle) {
                    sidebarToggle.addEventListener('click', () => {
                        this.toggleSidebar();
                    });
                }

                // Logout
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', async () => {
                        const ok = window.EducareTrack && typeof window.EducareTrack.confirmAction === 'function'
                            ? await window.EducareTrack.confirmAction('Are you sure you want to logout?', 'Confirm Logout', 'Logout', 'Cancel')
                            : true;
                        if (ok) {
                            localStorage.removeItem('educareTrack_user');
                            window.location.href = '../index.html';
                        }
                    });
                }

                const logoutBtnHeader = document.getElementById('logoutBtnHeader');
                if (logoutBtnHeader) {
                    logoutBtnHeader.addEventListener('click', async () => {
                        const ok = window.EducareTrack && typeof window.EducareTrack.confirmAction === 'function'
                            ? await window.EducareTrack.confirmAction('Are you sure you want to logout?', 'Confirm Logout', 'Logout', 'Cancel')
                            : true;
                        if (ok) {
                            localStorage.removeItem('educareTrack_user');
                            window.location.href = '../index.html';
                        }
                    });
                }

                // Refresh chart button
                const refreshChart = document.getElementById('refreshChart');
                if (refreshChart) {
                    refreshChart.addEventListener('click', () => {
                        this.loadRealAttendanceData();
                    });
                }

                // Time range selector
                const chartTimeRange = document.getElementById('chartTimeRange');
                if (chartTimeRange) {
                    chartTimeRange.addEventListener('change', (e) => {
                        const days = parseInt(e.target.value);
                        this.loadAttendanceDataForPeriod(days);
                    });
                }

                const clinicTrendRange = document.getElementById('clinicTrendRange');
                if (clinicTrendRange) {
                    clinicTrendRange.addEventListener('change', () => this.loadClinicAndAbsenceTrends());
                }
                const absenceTrendRange = document.getElementById('absenceTrendRange');
                if (absenceTrendRange) {
                    absenceTrendRange.addEventListener('change', () => this.loadClinicAndAbsenceTrends());
                }

                const refreshAtRisk = document.getElementById('refreshAtRisk');
                if (refreshAtRisk) {
                    refreshAtRisk.addEventListener('click', () => this.loadAtRiskStudents());
                }

                // Escape key to close modal
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeAnyOpenModal();
                    }
                });
            }

            async loadClinicAndAbsenceTrends() {
                try {
                    const clinicRangeEl = document.getElementById('clinicTrendRange');
                    const absenceRangeEl = document.getElementById('absenceTrendRange');
                    const clinicDays = clinicRangeEl ? parseInt(clinicRangeEl.value) : 30;
                    const absenceDays = absenceRangeEl ? parseInt(absenceRangeEl.value) : 90;
                    const end = new Date();
                    const clinicStart = new Date(end.getTime() - clinicDays * 24 * 60 * 60 * 1000);
                    const absenceStart = new Date(end.getTime() - absenceDays * 24 * 60 * 60 * 1000);
                    const clinicTrend = await EducareTrack.getClinicReasonTrend(clinicStart, end, 6);
                    const absenceTrend = await EducareTrack.getAbsenceReasonTrend(absenceStart, end, 8);
                    const excusedData = await EducareTrack.getExcusedVsUnexcusedAbsences(absenceStart, end);
                    const clinicCtxEl = document.getElementById('clinicReasonsChart');
                    const absenceCtxEl = document.getElementById('absenceReasonsChart');
                    const donutCtxEl = document.getElementById('excusedDonut');
                    const self = this;
                    if (clinicCtxEl) {
                        const ctx = clinicCtxEl.getContext('2d');
                        this.clinicReasonsChart = new Chart(ctx, {
                            type: 'bar',
                            data: { labels: clinicTrend.labels, datasets: [{ label: 'Visits', data: clinicTrend.counts, backgroundColor: '#3B82F6' }] },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                onClick: function(evt, elements, chart) {
                                    if (elements && elements.length > 0) {
                                        const index = elements[0].index;
                                        const label = chart.data.labels[index];
                                        self.openDrilldown('clinic', label, clinicStart, end);
                                    }
                                }
                            }
                        });
                    }
                    if (absenceCtxEl) {
                        const ctx = absenceCtxEl.getContext('2d');
                        this.absenceReasonsChart = new Chart(ctx, {
                            type: 'bar',
                            data: { labels: absenceTrend.labels, datasets: [{ label: 'Absences', data: absenceTrend.counts, backgroundColor: '#F59E0B' }] },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                onClick: function(evt, elements, chart) {
                                    if (elements && elements.length > 0) {
                                        const index = elements[0].index;
                                        const label = chart.data.labels[index];
                                        self.openDrilldown('absence', label, absenceStart, end);
                                    }
                                }
                            }
                        });
                    }
                    if (donutCtxEl) {
                        const ctx = donutCtxEl.getContext('2d');
                        this.excusedDonutChart = new Chart(ctx, {
                            type: 'doughnut',
                            data: { labels: ['Excused', 'Unexcused', 'Pending'], datasets: [{ data: [excusedData.approved, excusedData.rejected, excusedData.pending], backgroundColor: ['#10B981', '#EF4444', '#9CA3AF'] }] },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                        });
                    }
                } catch (error) {
                    console.error('Error loading clinic/absence trends:', error);
                }
            }

            async openDrilldown(type, label, startDate, endDate) {
                try {
                    const modal = document.getElementById('drilldownModal');
                    const titleEl = document.getElementById('drilldownTitle');
                    const subtitleEl = document.getElementById('drilldownSubtitle');
                    const metaEl = document.getElementById('drilldownMeta');
                    const contentEl = document.getElementById('drilldownContent');
                    const pivotEl = document.getElementById('pivotSelect');
                    if (!modal || !titleEl || !subtitleEl || !contentEl || !pivotEl) return;

                    titleEl.textContent = type === 'clinic' ? 'Clinic Visits' : 'Absence Excuse Letters';
                    subtitleEl.textContent = `Reason: ${label}`;
                    metaEl.textContent = `${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`;
                    contentEl.innerHTML = '<div class="text-gray-500 text-sm">Loading...</div>';
                    modal.classList.remove('hidden');

                    const fetchData = async () => {
                        let items = [];
                        if (type === 'clinic') {
                            items = await EducareTrack.getClinicReasonDetails({ startDate, endDate, reason: label });
                        } else {
                            items = await EducareTrack.getAbsenceReasonDetails({ startDate, endDate, reason: label });
                        }
                        this.renderDrilldown(items, type);
                    };

                    await fetchData();

                    const closeBtn = document.getElementById('closeDrilldown');
                    if (closeBtn) {
                        closeBtn.onclick = () => { modal.classList.add('hidden'); };
                    }

                    pivotEl.onchange = async (e) => {
                        const pivot = e.target.value;
                        let items = [];
                        if (type === 'clinic') {
                            items = await EducareTrack.getClinicReasonDetails({ startDate, endDate, reason: label });
                        } else {
                            items = await EducareTrack.getAbsenceReasonDetails({ startDate, endDate, reason: label });
                        }
                        if (pivot === 'none') {
                            this.renderDrilldown(items, type);
                        } else {
                            const groups = {};
                            items.forEach(it => {
                                const key = it[pivot] || 'Unknown';
                                groups[key] = groups[key] || [];
                                groups[key].push(it);
                            });
                            const html = Object.keys(groups).sort().map(key => {
                                const list = groups[key];
                                return `
                                    <div class="border border-gray-200 rounded-md">
                                        <div class="px-3 py-2 bg-gray-50 text-gray-700 text-sm flex items-center justify-between">
                                            <span>${pivot === 'class_id' ? 'Class' : 'Grade'}: ${key}</span>
                                            <span class="text-gray-500">${list.length} records</span>
                                        </div>
                                        <div class="divide-y divide-gray-100">
                                            ${list.map(it => this.renderDrilldownItem(it, type)).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('');
                            contentEl.innerHTML = html || '<div class="text-gray-500 text-sm">No records found</div>';
                        }
                    };
                } catch (error) {
                    console.error('Error opening drilldown:', error);
                }
            }

            renderDrilldown(items, type) {
                const contentEl = document.getElementById('drilldownContent');
                if (!contentEl) return;
                if (!items || items.length === 0) {
                    contentEl.innerHTML = '<div class="text-gray-500 text-sm">No records found</div>';
                    return;
                }
                contentEl.innerHTML = items.map(it => this.renderDrilldownItem(it, type)).join('');
            }

            renderDrilldownItem(it, type) {
                const dateText = (() => {
                    const t = type === 'clinic' ? it.timestamp : it.submittedAt;
                    if (!t) return '';
                    return t.toDate ? t.toDate().toLocaleString() : new Date(t).toLocaleString();
                })();
                const rightTag = type === 'clinic'
                    ? `<span class="text-xs px-2 py-1 rounded ${it.teacherValidationStatus === 'approved' ? 'bg-green-100 text-green-700' : it.teacherValidationStatus === 'rejected' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700'}">${it.teacherValidationStatus || 'pending'}</span>`
                    : `<span class="text-xs px-2 py-1 rounded ${it.status === 'approved' ? 'bg-green-100 text-green-700' : it.status === 'rejected' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700'}">${it.status || 'pending'}</span>`;
                return `
                    <div class="flex items-center justify-between p-3">
                        <div>
                            <div class="text-sm font-medium text-gray-800">${it.studentName || it.student_id}</div>
                            <div class="text-xs text-gray-500">${type === 'clinic' ? (it.notes || '') : ''}</div>
                            <div class="text-xs text-gray-400">${dateText}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500">${it.class_id || ''}${it.grade ? `  ${it.grade}` : ''}</div>
                            ${rightTag}
                        </div>
                    </div>
                `;
            }

            async loadAtRiskStudents() {
                try {
                    const end = new Date();
                    const start = new Date(end.getTime() - 14 * 24 * 60 * 60 * 1000);
                    const list = await EducareTrack.getAtRiskStudentsReport({ startDate: start, endDate: end, limit: 20 });
                    const container = document.getElementById('atRiskList');
                    if (!container) return;
                    if (!list || list.length === 0) {
                        container.innerHTML = '<div class="text-gray-500 text-sm">No at-risk students found</div>';
                        return;
                    }
                    container.innerHTML = list.map(item => `
                        <div class=\"flex items-center justify-between border border-gray-200 rounded-md p-3\">\n
                            <div>\n
                                <div class=\"text-sm font-medium text-gray-800\">${item.studentName}</div>\n
                                <div class=\"text-xs text-gray-500\">Class: ${item.class_id}</div>\n
                            </div>\n
                            <div class=\"flex items-center space-x-3\">\n
                                <span class=\"text-xs px-2 py-1 rounded bg-red-100 text-red-700\">${item.absentDays} absences</span>\n
                                <span class=\"text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-700\">${item.lateDays} lates</span>\n
                                <span class=\"text-xs px-2 py-1 rounded bg-gray-100 text-gray-700\">Risk ${item.riskScore}</span>\n
                            </div>\n
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Error loading at-risk students:', error);
                }
            }

            toggleSidebar() {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                
                if (sidebar && mainContent) {
                    if (sidebar.classList.contains('collapsed')) {
                        sidebar.classList.remove('collapsed');
                        mainContent.classList.remove('ml-16');
                        mainContent.classList.add('ml-64');
                    } else {
                        sidebar.classList.add('collapsed');
                        mainContent.classList.remove('ml-64');
                        mainContent.classList.add('ml-16');
                    }
                }
            }

            closeAnyOpenModal() {
                const modals = document.querySelectorAll('.fixed.inset-0');
                modals.forEach(modal => {
                    if (!modal.classList.contains('hidden')) {
                        modal.classList.add('hidden');
                    }
                });
            }

            showLoading() {
                const loadingSpinner = document.getElementById('loadingSpinner');
                if (loadingSpinner) {
                    loadingSpinner.classList.remove('hidden');
                }
            }

            hideLoading() {
                const loadingSpinner = document.getElementById('loadingSpinner');
                if (loadingSpinner) {
                    loadingSpinner.classList.add('hidden');
                }
            }

            showNotification(message, type = 'info') {
                if (window.EducareTrack && typeof window.EducareTrack.showNormalNotification === 'function') {
                    window.EducareTrack.showNormalNotification({ title: type === 'error' ? 'Error' : 'Info', message, type });
                }
            }
        }

        // Initialize dashboard when page loads
                document.addEventListener('DOMContentLoaded', function() {
                    window.dashboard = new AdminDashboard();
                });
            </script>
</body>
</html>
